{% extends "base.html" %}
{% load pa_bonus_extras %}
{% block title %} Manage Request #{{ request_obj.id }} {% endblock %}
{% block content %}
<h2>Žádost o čerpání #{{ request_obj.id }}</h2>

<!-- Client Information Table -->
<div class="client-info-section">
    <h3>Client Information</h3>
    <table class="client-info-table">
        <tr>
            <td><strong>Client Number:</strong></td>
            <td>{{ request_obj.user.user_number }}</td>
        </tr>
        <tr>
            <td><strong>Full Name:</strong></td>
            <td>{{ request_obj.user.first_name }} {{ request_obj.user.last_name }}</td>
        </tr>
        <tr>
            <td><strong>Email:</strong></td>
            <td>{{ request_obj.user.email }}</td>
        </tr>
        <tr>
            <td><strong>Region:</strong></td>
            <td>{{ request_obj.user.region.name|default:"No Region" }}</td>
        </tr>
        <tr>
            <td><strong>Available Balance:</strong></td>
            <td>{{ user_balance }} bodů</td>
        </tr>
    </table>
</div>

<div class="points-summary">
    <p class="total-points">Celková hodnota žádosti: {{ request_obj.total_points }} bodů</p>
</div>

<!-- Requested Items (Read-only) -->
<h3>Requested Items</h3>
{% if items %}
<table class="transactions-table">
    <thead>
        <tr>
            <th>Code</th>
            <th>Reward Name</th>
            <th>Point Cost Each</th>
            <th>Quantity</th>
            <th>Total Cost</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td>{{ item.reward.abra_code }}</td>
            <td>{{ item.reward.name }}</td>
            <td>{{ item.point_cost }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.quantity|multiply:item.point_cost }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No items in this request.</p>
{% endif %}

<!-- Management Form -->
<form method="post">
  {% csrf_token %}

  <h3>Customer Note (VISIBLE TO CLIENT)</h3>
  <textarea name="customer_note" rows="4" style="width: 100%;">{{ request_obj.note }}</textarea>

  <h3>Status</h3>
  <select name="status">
    {% for code, label in request_obj.REQUEST_STATUS %}
      <option value="{{ code }}" {% if request_obj.status == code %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>

  <h3>Manager Message (VISIBLE TO CLIENT)</h3>
  <textarea name="manager_message" rows="4" cols="50">{{ request_obj.description }}</textarea>
  
  <h3>Options</h3>
  <label>
    <input type="checkbox" name="allow_negative">
    Allow negative balance (override point limit)
  </label>
  
  <div style="margin-top: 20px;">
    <button type="submit">Save Changes</button>
    <a href="{% url 'export_telemarketing_file' request_obj.id %}" class="export-button" style="margin-left: 10px;">
        Export for Telemarketing
    </a>
  </div>
</form>

<style>
.client-info-section {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
}

.client-info-table {
    width: 100%;
    border-collapse: collapse;
}

.client-info-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #ddd;
}

.client-info-table td:first-child {
    width: 150px;
    background-color: #e9ecef;
}

.export-button {
    display: inline-block;
    padding: 8px 16px;
    background-color: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: bold;
}

.export-button:hover {
    background-color: #218838;
    color: white;
    text-decoration: none;
}

.points-summary {
    background-color: #e7f3ff;
    padding: 15px;
    border-radius: 5px;
    margin: 15px 0;
}

.total-points {
    font-size: 1.1em;
    font-weight: bold;
    margin: 0;
}
</style>
{% endblock %}